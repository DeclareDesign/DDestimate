<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Absorbing Fixed Effects with estimatr • estimatr</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../">estimatr</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Getting Started
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/getting-started.html">Getting Started with estimatr</a>
    </li>
    <li>
      <a href="../articles/regression-tables.html">Regression Tables with estimatr</a>
    </li>
    <li>
      <a href="../articles/absorbing-fixed-effects.html">Absorbing Fixed Effects with estimatr</a>
    </li>
    <li>
      <a href="../articles/estimatr-in-the-tidyverse.html">estimatr in the Tidyverse</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Technical Notes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/mathematical-notes.html">Mathematical Notes</a>
    </li>
    <li>
      <a href="../articles/benchmarking-estimatr.html">Simulations - Speed Comparisons</a>
    </li>
    <li>
      <a href="../articles/simulations-ols-variance.html">Simulations - OLS and Variance</a>
    </li>
    <li>
      <a href="../articles/simulations-debiasing-dim.html">Simulations - Debiasing Difference-in-Means</a>
    </li>
    <li>
      <a href="../articles/stata-wls-hat.html">How Stata's hat matrix differs with weights</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="http://discuss.declaredesign.org">Ask for Help</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Packages
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="http://declaredesign.org">DeclareDesign</a>
    </li>
    <li>
      <a href="http://randomizr.declaredesign.org">randomizr</a>
    </li>
    <li>
      <a href="http://fabricatr.declaredesign.org">fabricatr</a>
    </li>
    <li>
      <a href="http://estimatr.declaredesign.org">estimatr</a>
    </li>
  </ul>
</li>
<li>
  <a href="http://declaredesign.org">DeclareDesign home</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a></a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Absorbing Fixed Effects with estimatr</h1>
            
          </div>

    
    
<div class="contents">
<p>Whether analyzing a block-randomized experiment or adding fixed effects for a panel model, absorbing group means can speed up estimation time. The <code>fixed_effects</code> argument in both <code>lm_robust</code> and <code>iv_robust</code> allows you to do just that, although the speed gains are greatest with “HC1” standard errors. Specifying fixed effects is really simple.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(estimatr)
lmr_out &lt;-<span class="st"> </span><span class="kw"><a href="../reference/lm_robust.html">lm_robust</a></span>(mpg <span class="op">~</span><span class="st"> </span>hp, <span class="dt">data =</span> mtcars, <span class="dt">fixed_effects =</span> <span class="op">~</span><span class="st"> </span>cyl)
lmr_out</code></pre></div>
<pre><code>##       Estimate Std. Error   t value  Pr(&gt;|t|)    CI Lower    CI Upper DF
## hp -0.02403883 0.01503818 -1.598521 0.1211523 -0.05484314 0.006765475 28</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">lmr_out<span class="op">$</span>fixed_effects</code></pre></div>
<pre><code>##     cyl4     cyl6     cyl8 
## 28.65012 22.68246 20.12927</code></pre>
<p>Before proceeding, three quick notes:</p>
<ul>
<li>Most of the speed gains occur when estimating “HC1” robust standard errors, or “stata” standard errors when there is clustering. This is because most of the speed gains come from avoiding inverting a large matrix of group dummies, but this step is still necessary for “HC2”, “HC3”, and “CR2” standard errors.</li>
<li>While you can specify multiple sets of fixed effects, such as <code>fixed_effects = ~ year + country</code>, please ensure that your model is well-specified if you do so. If there are dependencies or overlapping groups across multiple sets of fixed effects, we cannot guarantee the correct degrees of freedom.</li>
<li>For now, weighted “CR2” estimation is not possible with fixed_effects.</li>
</ul>
<div id="speed-gains" class="section level2">
<h2 class="hasAnchor">
<a href="#speed-gains" class="anchor"></a>Speed gains</h2>
<p>In general, our speed gains will be greatest as the number of groups/fixed effects is large relative to the number of observations. Imagine we have 300 matched-pairs in an experiment.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Load packages for comparison</span>
<span class="kw">library</span>(microbenchmark)
<span class="kw">library</span>(sandwich)
<span class="kw">library</span>(lmtest)

<span class="co"># Create matched-pairs dataset using fabricatr</span>
<span class="kw">set.seed</span>(<span class="dv">40</span>)
<span class="kw">library</span>(fabricatr)
dat &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/fabricatr/topics/fabricate">fabricate</a></span>(
  <span class="dt">blocks =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/fabricatr/topics/fabricate">add_level</a></span>(<span class="dt">N =</span> <span class="dv">300</span>),
  <span class="dt">indiv =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/fabricatr/topics/fabricate">add_level</a></span>(<span class="dt">N =</span> <span class="dv">2</span>, <span class="dt">z =</span> <span class="kw">sample</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">1</span>), <span class="dt">y =</span> <span class="kw">rnorm</span>(N) <span class="op">+</span><span class="st"> </span>z)
)
<span class="kw">head</span>(dat)</code></pre></div>
<pre><code>##   blocks indiv z          y
## 1    001   001 1  1.4961828
## 2    001   002 0 -0.8595843
## 3    002   003 1  0.1709400
## 4    002   004 0 -0.3215731
## 5    003   005 1 -0.3037704
## 6    003   006 0 -1.4214866</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># With HC2</span>
<span class="kw"><a href="http://www.rdocumentation.org/packages/microbenchmark/topics/microbenchmark">microbenchmark</a></span>(
  <span class="st">`</span><span class="dt">base + sandwich</span><span class="st">`</span> =<span class="st"> </span>{
    lo &lt;-<span class="st"> </span><span class="kw">lm</span>(y <span class="op">~</span><span class="st"> </span>z <span class="op">+</span><span class="st"> </span><span class="kw">factor</span>(blocks), dat)
    <span class="kw"><a href="http://www.rdocumentation.org/packages/lmtest/topics/coeftest">coeftest</a></span>(lo, <span class="dt">vcov =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/sandwich/topics/vcovHC">vcovHC</a></span>(lo, <span class="dt">type =</span> <span class="st">"HC2"</span>))
  },
  <span class="st">`</span><span class="dt">lm_robust</span><span class="st">`</span> =<span class="st"> </span><span class="kw"><a href="../reference/lm_robust.html">lm_robust</a></span>(y <span class="op">~</span><span class="st"> </span>z <span class="op">+</span><span class="st"> </span><span class="kw">factor</span>(blocks), dat),
  <span class="st">`</span><span class="dt">lm_robust + fes</span><span class="st">`</span> =<span class="st"> </span><span class="kw"><a href="../reference/lm_robust.html">lm_robust</a></span>(y <span class="op">~</span><span class="st"> </span>z, <span class="dt">data =</span> dat, <span class="dt">fixed_effects =</span> <span class="op">~</span><span class="st"> </span>blocks),
  <span class="dt">times =</span> <span class="dv">50</span>
)</code></pre></div>
<pre><code>## Unit: milliseconds
##             expr       min        lq      mean    median        uq
##  base + sandwich 195.59275 209.81159 219.24240 217.35922 225.63997
##        lm_robust  85.36861  90.92141  96.62574  95.18862 100.50766
##  lm_robust + fes  52.67907  56.24784  60.17194  60.30979  62.69774
##        max neval
##  277.63258    50
##  113.86913    50
##   73.59198    50</code></pre>
<p>Speed gains are <em>considerably</em> greater with HC1 standard errors. This is because we need to get the hat matrix for HC2, HC3, and CR2 standard errors, which requires inverting that large matrix of dummies we previously avoided doing. HC0, HC1, CR0, and CRstata standard errors do not require this inversion.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># With HC1</span>
<span class="kw"><a href="http://www.rdocumentation.org/packages/microbenchmark/topics/microbenchmark">microbenchmark</a></span>(
  <span class="st">`</span><span class="dt">base + sandwich</span><span class="st">`</span> =<span class="st"> </span>{
    lo &lt;-<span class="st"> </span><span class="kw">lm</span>(y <span class="op">~</span><span class="st"> </span>z <span class="op">+</span><span class="st"> </span><span class="kw">factor</span>(blocks), dat)
    <span class="kw"><a href="http://www.rdocumentation.org/packages/lmtest/topics/coeftest">coeftest</a></span>(lo, <span class="dt">vcov =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/sandwich/topics/vcovHC">vcovHC</a></span>(lo, <span class="dt">type =</span> <span class="st">"HC1"</span>))
  },
  <span class="st">`</span><span class="dt">lm_robust</span><span class="st">`</span> =<span class="st"> </span><span class="kw"><a href="../reference/lm_robust.html">lm_robust</a></span>(
    y <span class="op">~</span><span class="st"> </span>z <span class="op">+</span><span class="st"> </span><span class="kw">factor</span>(blocks),
    dat,
    <span class="dt">se_type =</span> <span class="st">"HC1"</span>
  ),
  <span class="st">`</span><span class="dt">lm_robust + fes</span><span class="st">`</span> =<span class="st"> </span><span class="kw"><a href="../reference/lm_robust.html">lm_robust</a></span>(
    y <span class="op">~</span><span class="st"> </span>z, 
    <span class="dt">data =</span> dat,
    <span class="dt">fixed_effects =</span> <span class="op">~</span><span class="st"> </span>blocks,
    <span class="dt">se_type =</span> <span class="st">"HC1"</span>
  ),
  <span class="dt">times =</span> <span class="dv">50</span>
)</code></pre></div>
<pre><code>## Unit: milliseconds
##             expr        min         lq      mean    median        uq
##  base + sandwich 194.979418 207.383234 214.50206 210.90124 218.10445
##        lm_robust  68.085511  75.316219  81.17257  79.80612  86.70727
##  lm_robust + fes   8.284809   9.095577  11.18323  10.12290  12.96004
##        max neval
##  270.66784    50
##   98.69560    50
##   18.46223    50</code></pre>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#speed-gains">Speed gains</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright" style="flex:3;">
  <p>Developed by Graeme Blair, Jasper Cooper, Alexander Coppock, Macartan Humphreys, Luke Sonnet, Neal Fultz.</p>
  <p>Code is licensed under <a href="https://opensource.org/licenses/mit-license.php">MIT</a> license.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
