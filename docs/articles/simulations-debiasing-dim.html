<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simulations - Debiasing Difference-in-Means • estimatr</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../">estimatr</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Getting Started
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/getting-started.html">Getting Started with estimatr</a>
    </li>
    <li>
      <a href="../articles/regression-tables.html">Regression Tables with estimatr</a>
    </li>
    <li>
      <a href="../articles/absorbing-fixed-effects.html">Absorbing Fixed Effects with estimatr</a>
    </li>
    <li>
      <a href="../articles/estimatr-in-the-tidyverse.html">estimatr in the Tidyverse</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Technical Notes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/mathematical-notes.html">Mathematical Notes</a>
    </li>
    <li>
      <a href="../articles/benchmarking-estimatr.html">Simulations - Speed Comparisons</a>
    </li>
    <li>
      <a href="../articles/simulations-ols-variance.html">Simulations - OLS and Variance</a>
    </li>
    <li>
      <a href="../articles/simulations-debiasing-dim.html">Simulations - Debiasing Difference-in-Means</a>
    </li>
    <li>
      <a href="../articles/stata-wls-hat.html">How Stata's hat matrix differs with weights</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="http://discuss.declaredesign.org">Ask for Help</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Packages
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="http://declaredesign.org">DeclareDesign</a>
    </li>
    <li>
      <a href="http://randomizr.declaredesign.org">randomizr</a>
    </li>
    <li>
      <a href="http://fabricatr.declaredesign.org">fabricatr</a>
    </li>
    <li>
      <a href="http://estimatr.declaredesign.org">estimatr</a>
    </li>
  </ul>
</li>
<li>
  <a href="http://declaredesign.org">DeclareDesign home</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a></a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Simulations - Debiasing Difference-in-Means</h1>
                        <h4 class="author">Luke Sonnet</h4>
            
          </div>

    
    
<div class="contents">
<p>This document shows how providing <a href="/R/estimatr/"><code>estimatr</code></a> with the appropriate blocks and clusters that define a research design can eliminate bias when estimating treatment effects using <code><a href="../reference/difference_in_means.html">difference_in_means()</a></code>. More details about the estimators with references can be found in the <a href="/R/estimatr/articles/mathematical-notes.html">mathematical notes</a>.</p>
<p>I am going to skip simple difference-in-means, and just straight to the case with blocks. Throughout I will use <a href="/R/DeclareDesign/"><code>DeclareDesign</code></a> to help diagnose the properties of the various estimators.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(DeclareDesign)</code></pre></div>
<pre><code>## Loading required package: randomizr</code></pre>
<pre><code>## Loading required package: fabricatr</code></pre>
<pre><code>## Loading required package: estimatr</code></pre>
<div id="blocked-designs" class="section level1">
<h1 class="hasAnchor">
<a href="#blocked-designs" class="anchor"></a>Blocked designs</h1>
<p>Blocking is a common strategy in experimental design used to improve the efficiency of estimators by ensuring that units with similar potential outcomes, when blocked, will be represented in both treatment conditions.</p>
<div id="fixed-probability-of-treatment" class="section level2">
<h2 class="hasAnchor">
<a href="#fixed-probability-of-treatment" class="anchor"></a>Fixed probability of treatment</h2>
<p>Let’s first consider an example where blocks predict the potential outcomes but where the probability of treatment is constant across blocks. In this case, estimating a simple difference-in-means without passing the information about the blocks will not bias the estimate, but it will not take advantage of the increased efficiency blocking provides and the standard errors will be unnecessarily large. Let’s see that in an example.</p>
<p>First, let’s set up our data and randomization scheme. In all of these analyses, our estimand will be the average treatment effect</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Define population with blocks of the same size, with some block-level shock</span>
simp_blocks &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/DeclareDesign/topics/declare_population">declare_population</a></span>(
  <span class="dt">blocks =</span> <span class="kw">add_level</span>(
    <span class="dt">N =</span> <span class="dv">40</span>,
    <span class="dt">block_shock =</span> <span class="kw">runif</span>(N, <span class="dv">0</span>, <span class="dv">10</span>)
  ),
  <span class="dt">individual =</span> <span class="kw">add_level</span>(
    <span class="dt">N =</span> <span class="dv">8</span>,
    <span class="dt">epsilon =</span> <span class="kw">rnorm</span>(N)
  )
)
<span class="co"># Block shocks influnce Y_Z_1, the treatment potential outcome</span>
blocked_pos &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/DeclareDesign/topics/declare_potential_outcomes">declare_potential_outcomes</a></span>(Y <span class="op">~</span><span class="st"> </span>Z <span class="op">*</span><span class="st"> </span><span class="fl">0.5</span> <span class="op">*</span><span class="st"> </span>block_shock <span class="op">+</span><span class="st"> </span>epsilon)
<span class="co"># Complete random assignment of half of units in each block</span>
blocked_assign &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/DeclareDesign/topics/declare_assignment">declare_assignment</a></span>(<span class="dt">blocks =</span> blocks, <span class="dt">prob =</span> <span class="fl">0.5</span>)
<span class="co"># Estimand is the ATE</span>
ate &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/DeclareDesign/topics/declare_estimand">declare_estimand</a></span>(<span class="dt">ATE =</span> <span class="kw">mean</span>(Y_Z_<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>Y_Z_<span class="dv">0</span>))</code></pre></div>
<p>Now let’s define our two estimators, one that doesn’t account for blocking and one that does. The estimator that accounts for blocking essentially will compute treatment effects within blocks and then will take a weighted average across blocks. Details and references can be found in the <a href="/R/estimatr/articles/mathematical-notes.html#difference_in_means-notes">mathematical notes</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dim &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/DeclareDesign/topics/declare_estimator">declare_estimator</a></span>(Y <span class="op">~</span><span class="st"> </span>Z, <span class="dt">label =</span> <span class="st">"DIM"</span>)
dim_bl &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/DeclareDesign/topics/declare_estimator">declare_estimator</a></span>(Y <span class="op">~</span><span class="st"> </span>Z, <span class="dt">blocks =</span> blocks, <span class="dt">label =</span> <span class="st">"DIM blocked"</span>)

<span class="co"># Our design</span>
simp_bl_des &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/DeclareDesign/topics/declare_design">declare_design</a></span>(
  simp_blocks,
  blocked_pos,
  blocked_assign,
  ate,
  dim,
  dim_bl
)</code></pre></div>
<pre><code>## Warning: Outcome variables (Y) were declared in a Potential Outcome step
## (), but never later revealed.</code></pre>
<pre><code>## Warning: Attempting to inject a `declare_reveal(Y, Z)` step after
## Assignment step ()</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Our diagnosands of interest</span>
my_diagnosands &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/DeclareDesign/topics/declare_diagnosands">declare_diagnosands</a></span>(
  <span class="st">`</span><span class="dt">Bias</span><span class="st">`</span> =<span class="st"> </span><span class="kw">mean</span>(est <span class="op">-</span><span class="st"> </span>estimand),
  <span class="st">`</span><span class="dt">Coverage</span><span class="st">`</span> =<span class="st">  </span><span class="kw">mean</span>(estimand <span class="op">&lt;=</span><span class="st"> </span>ci_upper <span class="op">&amp;</span><span class="st"> </span>estimand <span class="op">&gt;=</span><span class="st"> </span>ci_lower),
  <span class="st">`</span><span class="dt">Mean of Estimated ATE</span><span class="st">`</span> =<span class="st"> </span><span class="kw">mean</span>(est),
  <span class="st">`</span><span class="dt">Mean of True ATE (Estimand)</span><span class="st">`</span> =<span class="st"> </span><span class="kw">mean</span>(estimand),
  <span class="st">`</span><span class="dt">Mean Standard Error</span><span class="st">`</span> =<span class="st"> </span><span class="kw">mean</span>(se)
)</code></pre></div>
<p>Let’s get a sample dataset to show the relationship between treatment potential outcomes and blocks.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">42</span>)
dat &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/DeclareDesign/topics/post_design">draw_data</a></span>(simp_bl_des)
<span class="kw">plot</span>(dat<span class="op">$</span>blocks, dat<span class="op">$</span>Y_Z_<span class="dv">1</span>,
     <span class="dt">ylab =</span> <span class="st">"Y_Z_1 (treatment PO)"</span>, <span class="dt">xlab =</span> <span class="st">"Block ID"</span>)</code></pre></div>
<p><img src="simulations-debiasing-dim_files/figure-html/unnamed-chunk-4-1.png" width="384"></p>
<p>As you can see, the blocks tend to have clustered treatment potential outcomes. Now let’s compare the performance of the two estimators using our diagnosands of interest.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">42</span>)
simp_bl_dig &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/DeclareDesign/topics/diagnose_design">diagnose_design</a></span>(
  simp_bl_des,
  <span class="dt">sims =</span> <span class="dv">5000</span>,
  <span class="dt">diagnosands =</span> my_diagnosands
)</code></pre></div>
<table class="table">
<thead><tr class="header">
<th></th>
<th align="right">Naive DIM</th>
<th align="right">Block DIM</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Mean of True ATE (Estimand)</td>
<td align="right">2.506</td>
<td align="right">2.506</td>
</tr>
<tr class="even">
<td>Mean of Estimated ATE</td>
<td align="right">2.505</td>
<td align="right">2.505</td>
</tr>
<tr class="odd">
<td>Bias</td>
<td align="right">0.000</td>
<td align="right">0.000</td>
</tr>
<tr class="even">
<td>se(Bias)</td>
<td align="right">0.002</td>
<td align="right">0.002</td>
</tr>
<tr class="odd">
<td>Coverage</td>
<td align="right">0.995</td>
<td align="right">0.949</td>
</tr>
<tr class="even">
<td>se(Coverage)</td>
<td align="right">0.001</td>
<td align="right">0.003</td>
</tr>
<tr class="odd">
<td>Mean Standard Error</td>
<td align="right">0.159</td>
<td align="right">0.112</td>
</tr>
<tr class="even">
<td>se(Mean Standard Error)</td>
<td align="right">0.000</td>
<td align="right">0.000</td>
</tr>
</tbody>
</table>
<p>Both estimates are unbiased (and indeed are identical), and you can see that standard errors when accounting for blocking are much smaller (leading to better coverage and more efficient estimation). Note that the <code>"se"</code> rows in the table describe the uncertainty arising from the simulation and can help us know well we estimated our bias and variance using the simulation approach.</p>
</div>
<div id="correlated-potential-outcomes-and-treatment-probabilities" class="section level2">
<h2 class="hasAnchor">
<a href="#correlated-potential-outcomes-and-treatment-probabilities" class="anchor"></a>Correlated potential outcomes and treatment probabilities</h2>
<p>However, not accounting for blocking becomes more problematic if the probability of treatment in each block is correlated with the potential outcomes. Imagine, for example, that you are working with a partner who wants their intervention to both have a big effect and be amenable to rigorous analysis (in which case, congratulations). In this scenario, they may suspect certain types of units have higher treatment effects and want those units to be treated more often. In this case, if blocks with higher treatment effects are treated more often, the naive estimator will overrepresent those treated units and upwardly bias the ATE. Accounting for blocking by estimating treatment effects within block and then weighting for the probability of treatment, which our <code><a href="../reference/difference_in_means.html">difference_in_means()</a></code> estimator does when blocks are specified, will eliminate this bias.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">corr_blocks &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/DeclareDesign/topics/declare_population">declare_population</a></span>(
  <span class="dt">blocks =</span> <span class="kw">add_level</span>(
    <span class="dt">N =</span> <span class="dv">60</span>,
    <span class="dt">block_shock =</span> <span class="kw">runif</span>(N, <span class="dv">0</span>, <span class="dv">10</span>),
    <span class="dt">indivs_per_block =</span> <span class="dv">8</span>,
    <span class="co"># if block shock is &gt; 5, treat 6 units, otherwise treat 2</span>
    <span class="dt">m_treat =</span> <span class="kw">ifelse</span>(block_shock <span class="op">&gt;</span><span class="st"> </span><span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">2</span>)
  ),
  <span class="dt">individual =</span> <span class="kw">add_level</span>(
    <span class="dt">N =</span> indivs_per_block,
    <span class="dt">epsilon =</span> <span class="kw">rnorm</span>(N, <span class="dt">sd =</span> <span class="dv">3</span>)
  )
)
<span class="co"># Use same potential outcomes as above, but now treatment probability varies across blocks</span>
corr_blocked_assign &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/DeclareDesign/topics/declare_assignment">declare_assignment</a></span>(
  <span class="dt">blocks =</span> blocks,
  <span class="co"># The next line will just get the number of treated for a block from</span>
  <span class="co"># the first unit in that block</span>
  <span class="dt">block_m =</span> m_treat[<span class="op">!</span><span class="kw">duplicated</span>(blocks)]
)
corr_bl_des &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/DeclareDesign/topics/declare_design">declare_design</a></span>(
  corr_blocks,
  blocked_pos,
  corr_blocked_assign,
  ate,
  dim,
  dim_bl
)</code></pre></div>
<pre><code>## Warning: Outcome variables (Y) were declared in a Potential Outcome step
## (), but never later revealed.</code></pre>
<pre><code>## Warning: Attempting to inject a `declare_reveal(Y, Z)` step after
## Assignment step ()</code></pre>
<p>As you can see below, the probability of treatment is strongly correlated with the treatment effect.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">43</span>)
dat &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/DeclareDesign/topics/post_design">draw_data</a></span>(corr_bl_des)
<span class="kw">plot</span>(<span class="kw">factor</span>(dat<span class="op">$</span>m_treat <span class="op">/</span><span class="st"> </span><span class="dv">8</span>), dat<span class="op">$</span>Y_Z_<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>dat<span class="op">$</span>Y_Z_<span class="dv">0</span>,
     <span class="dt">ylab =</span> <span class="st">"True treat. effect"</span>, <span class="dt">xlab =</span> <span class="st">"Pr treatment in block"</span>)</code></pre></div>
<p><img src="simulations-debiasing-dim_files/figure-html/unnamed-chunk-8-1.png" width="384"></p>
<p>Let’s diagnose these estimators.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">44</span>)
corr_bl_dig &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/DeclareDesign/topics/diagnose_design">diagnose_design</a></span>(
  corr_bl_des,
  <span class="dt">sims =</span> <span class="dv">5000</span>,
  <span class="dt">diagnosands =</span> my_diagnosands,
  <span class="dt">parallel =</span> <span class="ot">TRUE</span>
)</code></pre></div>
<table class="table">
<thead><tr class="header">
<th></th>
<th align="right">Naive DIM</th>
<th align="right">Block DIM</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Mean of True ATE (Estimand)</td>
<td align="right">2.502</td>
<td align="right">2.502</td>
</tr>
<tr class="even">
<td>Mean of Estimated ATE</td>
<td align="right">3.119</td>
<td align="right">2.499</td>
</tr>
<tr class="odd">
<td>Bias</td>
<td align="right">0.617</td>
<td align="right">-0.003</td>
</tr>
<tr class="even">
<td>se(Bias)</td>
<td align="right">0.005</td>
<td align="right">0.005</td>
</tr>
<tr class="odd">
<td>Coverage</td>
<td align="right">0.421</td>
<td align="right">0.944</td>
</tr>
<tr class="even">
<td>se(Coverage)</td>
<td align="right">0.008</td>
<td align="right">0.004</td>
</tr>
<tr class="odd">
<td>Mean Standard Error</td>
<td align="right">0.287</td>
<td align="right">0.316</td>
</tr>
<tr class="even">
<td>se(Mean Standard Error)</td>
<td align="right">0.000</td>
<td align="right">0.000</td>
</tr>
</tbody>
</table>
<p>As you can see, the bias and coverage are all wrong for the naive difference in means, while our corrected estimator has no bias and the coverage is closer to the nominal level.</p>
</div>
</div>
<div id="clustered-designs" class="section level1">
<h1 class="hasAnchor">
<a href="#clustered-designs" class="anchor"></a>Clustered designs</h1>
<p>Another common design involves clustered treatment assignment, where units are can only be treated in groups. This often arises when treatments only can happen at the classroom, village, or some other aggregated level, but you can observe outcomes at a lower level, such as a student in a classroom or a voter in a village.</p>
<div id="clusters-of-the-same-size" class="section level2">
<h2 class="hasAnchor">
<a href="#clusters-of-the-same-size" class="anchor"></a>Clusters of the same size</h2>
<p>With clustered designs, the naive difference-in-means estimate of the ATE will be unbiased. However, if the potential outcomes are correlated with cluster, than the naive standard error will underestimate the standard error. This is because the sampling variability of the estimated ATE is greater when certain clusters with similar potential outcomes will be in the same treatment status across runs. If you pass <code>clusters</code> to our difference-in-means estimator, we properly account for this increase in the sampling variability.</p>
<p>Let’s see this in action.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Define clustered data</span>
simp_clusts &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/DeclareDesign/topics/declare_population">declare_population</a></span>(
  <span class="dt">clusters =</span> <span class="kw">add_level</span>(
    <span class="dt">N =</span> <span class="dv">40</span>,
    <span class="dt">clust_shock =</span> <span class="kw">runif</span>(N, <span class="dv">0</span>, <span class="dv">10</span>)
  ),
  <span class="dt">individual =</span> <span class="kw">add_level</span>(
    <span class="dt">N =</span> <span class="dv">8</span>,
    <span class="dt">epsilon =</span> <span class="kw">rnorm</span>(N)
  )
)
<span class="co"># Treatment potential outcomes correlated with cluster shock</span>
clustered_POs &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/DeclareDesign/topics/declare_potential_outcomes">declare_potential_outcomes</a></span>(Y <span class="op">~</span><span class="st"> </span>Z <span class="op">*</span><span class="st"> </span><span class="fl">0.2</span> <span class="op">*</span><span class="st"> </span>clust_shock <span class="op">+</span><span class="st"> </span>epsilon)

<span class="co"># Clustered assignment to treatment</span>
clustered_assign &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/DeclareDesign/topics/declare_assignment">declare_assignment</a></span>(<span class="dt">clusters =</span> clusters, <span class="dt">prob =</span> <span class="fl">0.5</span>)

ate &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/DeclareDesign/topics/declare_estimand">declare_estimand</a></span>(<span class="dt">ATE =</span> <span class="kw">mean</span>(Y_Z_<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>Y_Z_<span class="dv">0</span>))

<span class="co"># Specify our two estimators</span>
dim &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/DeclareDesign/topics/declare_estimator">declare_estimator</a></span>(Y <span class="op">~</span><span class="st"> </span>Z, <span class="dt">label =</span> <span class="st">"DIM"</span>)
dim_cl &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/DeclareDesign/topics/declare_estimator">declare_estimator</a></span>(Y <span class="op">~</span><span class="st"> </span>Z, <span class="dt">clusters =</span> clusters, <span class="dt">label =</span> <span class="st">"DIM clustered"</span>)

simp_cl_des &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/DeclareDesign/topics/declare_design">declare_design</a></span>(
  simp_clusts,
  clustered_POs,
  clustered_assign,
  ate,
  dim,
  dim_cl
)</code></pre></div>
<pre><code>## Warning: Outcome variables (Y) were declared in a Potential Outcome step
## (), but never later revealed.</code></pre>
<pre><code>## Warning: Attempting to inject a `declare_reveal(Y, Z)` step after
## Assignment step ()</code></pre>
<p>Let’s look at an example of the data generated by this design. As you can see, treatment is clustered.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">45</span>)
dat &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/DeclareDesign/topics/post_design">draw_data</a></span>(simp_cl_des)
<span class="kw">table</span>(<span class="dt">Z =</span> dat<span class="op">$</span>Z, <span class="dt">clusters =</span> dat<span class="op">$</span>clusters)</code></pre></div>
<pre><code>##    clusters
## Z   01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 23
##   0  8  0  0  0  8  8  8  0  0  0  0  0  8  8  8  0  0  0  0  8  8  0  8
##   1  0  8  8  8  0  0  0  8  8  8  8  8  0  0  0  8  8  8  8  0  0  8  0
##    clusters
## Z   24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40
##   0  0  8  8  8  0  8  8  8  0  8  0  8  8  0  8  0  0
##   1  8  0  0  0  8  0  0  0  8  0  8  0  0  8  0  8  8</code></pre>
<p>Furthermore, treatment potential outcomes are correlated with cluster.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(dat<span class="op">$</span>clusters, dat<span class="op">$</span>Y_Z_<span class="dv">1</span>,
     <span class="dt">ylab =</span> <span class="st">"Y_Z_1 (treatment PO)"</span>, <span class="dt">xlab =</span> <span class="st">"Cluster ID"</span>)</code></pre></div>
<p><img src="simulations-debiasing-dim_files/figure-html/unnamed-chunk-13-1.png" width="384"></p>
<p>Let’s diagnose this design.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">46</span>)
simp_cl_dig &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/DeclareDesign/topics/diagnose_design">diagnose_design</a></span>(
  simp_cl_des,
  <span class="dt">sims =</span> <span class="dv">5000</span>,
  <span class="dt">diagnosands =</span> my_diagnosands
)</code></pre></div>
<table class="table">
<thead><tr class="header">
<th></th>
<th align="right">Naive DIM</th>
<th align="right">Cluster DIM</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Mean of True ATE (Estimand)</td>
<td align="right">1.002</td>
<td align="right">1.002</td>
</tr>
<tr class="even">
<td>Mean of Estimated ATE</td>
<td align="right">1.007</td>
<td align="right">1.007</td>
</tr>
<tr class="odd">
<td>Bias</td>
<td align="right">0.004</td>
<td align="right">0.004</td>
</tr>
<tr class="even">
<td>se(Bias)</td>
<td align="right">0.002</td>
<td align="right">0.002</td>
</tr>
<tr class="odd">
<td>Coverage</td>
<td align="right">0.899</td>
<td align="right">0.978</td>
</tr>
<tr class="even">
<td>se(Coverage)</td>
<td align="right">0.004</td>
<td align="right">0.002</td>
</tr>
<tr class="odd">
<td>Mean Standard Error</td>
<td align="right">0.120</td>
<td align="right">0.170</td>
</tr>
<tr class="even">
<td>se(Mean Standard Error)</td>
<td align="right">0.000</td>
<td align="right">0.000</td>
</tr>
</tbody>
</table>
<p>As you can see, the estimates are the same but the coverage for the naive difference-in-means is below the nominal level of 95 percent. The design-aware difference-in-means that accounts for clustering is conservative and in this case is a more appropriate estimator.</p>
</div>
<div id="clusters-of-different-sizes" class="section level2">
<h2 class="hasAnchor">
<a href="#clusters-of-different-sizes" class="anchor"></a>Clusters of different sizes</h2>
<p>When clusters are different sizes, and potential outcomes are correlated with cluster size, the difference-in-means estimator is no longer appropriate as it is biased. One solution is to use the Horvitz-Thompson estimator, which is actually a difference-in-totals estimator.</p>
<p>In the below, I use simulation to show that the difference-in-means estimator cannot account for the correlation between cluster size and potential outcomes, while the Horvitz-Thompson estimator can. I will use simple random assignment for the clusters as this estimation is faster.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Correlated cluster size and potential outcomes</span>
diff_size_cls &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/DeclareDesign/topics/declare_population">declare_population</a></span>(
  <span class="dt">clusters =</span> <span class="kw">add_level</span>(
    <span class="dt">N =</span> <span class="dv">10</span>,
    <span class="dt">clust_shock =</span> <span class="kw">runif</span>(N, <span class="dv">0</span>, <span class="dv">10</span>),
    <span class="dt">indivs_per_clust =</span> <span class="kw">ceiling</span>(clust_shock),
    <span class="dt">condition_pr =</span> <span class="fl">0.5</span>
  ),
  <span class="dt">individual =</span> <span class="kw">add_level</span>(
    <span class="dt">N =</span> indivs_per_clust,
    <span class="dt">epsilon =</span> <span class="kw">rnorm</span>(N, <span class="dt">sd =</span> <span class="dv">3</span>)
  )
)
clustered_POs &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/DeclareDesign/topics/declare_potential_outcomes">declare_potential_outcomes</a></span>(Y <span class="op">~</span><span class="st"> </span>Z <span class="op">*</span><span class="st"> </span><span class="fl">0.4</span> <span class="op">*</span><span class="st"> </span>clust_shock <span class="op">+</span><span class="st"> </span>epsilon)

ht_cl &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/DeclareDesign/topics/declare_estimator">declare_estimator</a></span>(
  <span class="dt">formula =</span> Y <span class="op">~</span><span class="st"> </span>Z,
  <span class="co"># Give your randomization declaration to HT and it sorts it out!</span>
  <span class="dt">ra_declaration =</span> randomizr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/randomizr/topics/declare_ra">declare_ra</a></span>(<span class="dt">clusters =</span> <span class="kw">with</span>(data, clusters), <span class="dt">prob =</span> <span class="fl">0.5</span>),
  <span class="dt">model =</span> estimatr<span class="op">::</span>horvitz_thompson,
  <span class="dt">label =</span> <span class="st">"Horvitz-Thompson Clustered"</span>
)

diff_cl_des &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/DeclareDesign/topics/declare_design">declare_design</a></span>(
  diff_size_cls,
  clustered_POs,
  clustered_assign,
  ate,
  dim_cl,
  ht_cl
)</code></pre></div>
<pre><code>## Warning: Outcome variables (Y) were declared in a Potential Outcome step
## (), but never later revealed.</code></pre>
<pre><code>## Warning: Attempting to inject a `declare_reveal(Y, Z)` step after
## Assignment step ()</code></pre>
<p>Now let’s diagnose!</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">47</span>)
diff_cl_dig &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/DeclareDesign/topics/diagnose_design">diagnose_design</a></span>(
  diff_cl_des,
  <span class="dt">sims =</span> <span class="dv">50000</span>,
  <span class="dt">diagnosands =</span> my_diagnosands
)</code></pre></div>
<table class="table">
<thead><tr class="header">
<th></th>
<th align="right">Cluster DIM</th>
<th align="right">Clust. Horvitz-Thompson</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Mean of True ATE (Estimand)</td>
<td align="right">2.555</td>
<td align="right">2.555</td>
</tr>
<tr class="even">
<td>Mean of Estimated ATE</td>
<td align="right">2.505</td>
<td align="right">2.554</td>
</tr>
<tr class="odd">
<td>Bias</td>
<td align="right">-0.049</td>
<td align="right">-0.001</td>
</tr>
<tr class="even">
<td>se(Bias)</td>
<td align="right">0.004</td>
<td align="right">0.005</td>
</tr>
<tr class="odd">
<td>Coverage</td>
<td align="right">0.959</td>
<td align="right">0.955</td>
</tr>
<tr class="even">
<td>se(Coverage)</td>
<td align="right">0.001</td>
<td align="right">0.001</td>
</tr>
<tr class="odd">
<td>Mean Standard Error</td>
<td align="right">0.918</td>
<td align="right">1.476</td>
</tr>
<tr class="even">
<td>se(Mean Standard Error)</td>
<td align="right">0.001</td>
<td align="right">0.002</td>
</tr>
</tbody>
</table>
<p>As you can see, the Horvitz-Thompson estimate is unbiased while the DIM is biased (observe how the standard error of the DIM bias is much smaller than the bias, while the Horvitz-Thompson bias is much smaller than the standard error of the bias).</p>
<p>Unfortunately, the cost of this lower bias is much higher variance. If you look at the Mean Standard Error, you’ll see that the standard error for the Horvitz-Thompson estimator is on average over 50 percent greater than the standard error for the biased difference-in-means estimator.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#blocked-designs">Blocked designs</a><ul class="nav nav-pills nav-stacked">
<li><a href="#fixed-probability-of-treatment">Fixed probability of treatment</a></li>
      <li><a href="#correlated-potential-outcomes-and-treatment-probabilities">Correlated potential outcomes and treatment probabilities</a></li>
      </ul>
</li>
      <li>
<a href="#clustered-designs">Clustered designs</a><ul class="nav nav-pills nav-stacked">
<li><a href="#clusters-of-the-same-size">Clusters of the same size</a></li>
      <li><a href="#clusters-of-different-sizes">Clusters of different sizes</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright" style="flex:3;">
  <p>Developed by Graeme Blair, Jasper Cooper, Alexander Coppock, Macartan Humphreys, Luke Sonnet, Neal Fultz.</p>
  <p>Code is licensed under <a href="https://opensource.org/licenses/mit-license.php">MIT</a> license.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
