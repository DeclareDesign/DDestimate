<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>estimatr in the Tidyverse • estimatr</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../">estimatr</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Getting Started
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/getting-started.html">Getting Started with estimatr</a>
    </li>
    <li>
      <a href="../articles/regression-tables.html">Regression Tables with estimatr</a>
    </li>
    <li>
      <a href="../articles/absorbing-fixed-effects.html">Absorbing Fixed Effects with estimatr</a>
    </li>
    <li>
      <a href="../articles/estimatr-in-the-tidyverse.html">estimatr in the Tidyverse</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Technical Notes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/mathematical-notes.html">Mathematical Notes</a>
    </li>
    <li>
      <a href="../articles/benchmarking-estimatr.html">Simulations - Speed Comparisons</a>
    </li>
    <li>
      <a href="../articles/simulations-ols-variance.html">Simulations - OLS and Variance</a>
    </li>
    <li>
      <a href="../articles/simulations-debiasing-dim.html">Simulations - Debiasing Difference-in-Means</a>
    </li>
    <li>
      <a href="../articles/stata-wls-hat.html">How Stata's hat matrix differs with weights</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="http://discuss.declaredesign.org">Ask for Help</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Packages
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="http://declaredesign.org">DeclareDesign</a>
    </li>
    <li>
      <a href="http://randomizr.declaredesign.org">randomizr</a>
    </li>
    <li>
      <a href="http://fabricatr.declaredesign.org">fabricatr</a>
    </li>
    <li>
      <a href="http://estimatr.declaredesign.org">estimatr</a>
    </li>
  </ul>
</li>
<li>
  <a href="http://declaredesign.org">DeclareDesign home</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a></a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>estimatr in the Tidyverse</h1>
            
          </div>

    
    
<div class="contents">
<p>The <code>estimatr</code> package estimates linear and instrumental variable regressions quickly and with robust standard errors. We designed the package to play well with the “tidyverse”, which is a suite of packages developed by RStudio. The main way we accomplish this is making it easy to turn model fits into data.frames, the data format expected by many tidyverse packages. This vignette will show you how to <code>estimatr</code> functions with four tidyverse packages: <code>broom</code>, <code>dplyr</code>, <code>purrr</code>, and <code>ggplot2</code>.</p>
<div id="turning-model-objects-into-data-frames" class="section level2">
<h2 class="hasAnchor">
<a href="#turning-model-objects-into-data-frames" class="anchor"></a>Turning model objects into data.frames</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(estimatr)
fit &lt;-<span class="st"> </span><span class="kw"><a href="../reference/lm_robust.html">lm_robust</a></span>(mpg <span class="op">~</span><span class="st"> </span>disp, <span class="dt">data =</span> mtcars)
<span class="kw"><a href="../reference/tidy.html">tidy</a></span>(fit)</code></pre></div>
<pre><code>##          term    estimate   std.error      p.value    ci.lower    ci.upper
## 1 (Intercept) 29.59985476 1.490268903 8.189608e-19 26.55631962 32.64338989
## 2        disp -0.04121512 0.005170197 6.743097e-09 -0.05177407 -0.03065617
##   df outcome
## 1 30     mpg
## 2 30     mpg</code></pre>
<p>The <code>fit</code> objects is an <code>lm_robust</code> object. When you call <code><a href="../reference/tidy.html">tidy(fit)</a></code> it turns the fit into a dataframe. This function and behavior are explictly modeled on the <code>broom</code> package, a tidyverse package for making model objects into data.frames.</p>
<p>Once the model fits are data.frames, it’s easy to pipe the output into <code>dplyr</code> data manipulation functions:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dplyr)
fit <span class="op">%&gt;%</span>
<span class="st">  </span>tidy <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/dplyr/topics/mutate">mutate</a></span>(<span class="dt">t.stat =</span> estimate <span class="op">/</span><span class="st"> </span>std.error,
         <span class="dt">significant =</span> p.value <span class="op">&lt;=</span><span class="st"> </span><span class="fl">0.05</span>)</code></pre></div>
<pre><code>##          term    estimate   std.error      p.value    ci.lower    ci.upper
## 1 (Intercept) 29.59985476 1.490268903 8.189608e-19 26.55631962 32.64338989
## 2        disp -0.04121512 0.005170197 6.743097e-09 -0.05177407 -0.03065617
##   df outcome    t.stat significant
## 1 30     mpg 19.862090        TRUE
## 2 30     mpg -7.971672        TRUE</code></pre>
</div>
<div id="putting-robust-standard-errors-in-a-ggplot" class="section level2">
<h2 class="hasAnchor">
<a href="#putting-robust-standard-errors-in-a-ggplot" class="anchor"></a>Putting robust standard errors in a ggplot</h2>
<p>If you want to overlay a regression model on a scatterplot, the <code>stat_smooth</code> function in <code>ggplot2</code> is great. But if you run <code><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_smooth">stat_smooth(method = "lm")</a></code>, ggplot will add a confidence interval based on classical variance calculations. If you want to use robust standard errors (and you almost certainly do, since homoskedasticity is an unnecessary and often implausible assumption), then use <code><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_smooth">stat_smooth(method = "lm_robust")</a></code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ggplot2)
<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(mtcars, <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(mpg, disp)) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_point">geom_point</a></span>() <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_smooth">stat_smooth</a></span>(<span class="dt">method =</span> <span class="st">"lm_robust"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">theme_bw</a></span>()</code></pre></div>
<p><img src="estimatr-in-the-tidyverse_files/figure-html/unnamed-chunk-3-1.png" width="672"></p>
</div>
<div id="running-multiple-versions-of-a-model-with-purrr" class="section level2">
<h2 class="hasAnchor">
<a href="#running-multiple-versions-of-a-model-with-purrr" class="anchor"></a>Running multiple versions of a model with purrr</h2>
<p>Sometimes, we want to run multiple versions of a regression mode, perhaps model on subsets of the data. This code runs three regressions on three subsets of the data and stacks the output into a single data.frame. We use the <code>map</code> function from the <code>purrr</code> package twice.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(purrr)
gg_df &lt;-
<span class="st">  </span>mtcars <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">split</span>(.<span class="op">$</span>cyl) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/map">map</a></span>(<span class="op">~</span><span class="st"> </span><span class="kw"><a href="../reference/lm_robust.html">lm_robust</a></span>(mpg <span class="op">~</span><span class="st"> </span>disp, <span class="dt">data =</span> .)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/map">map</a></span>(tidy) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/dplyr/topics/bind">bind_rows</a></span>(<span class="dt">.id =</span> <span class="st">"cyl"</span>)
gg_df</code></pre></div>
<pre><code>##   cyl        term     estimate   std.error      p.value    ci.lower
## 1   4 (Intercept) 40.871955322 3.507137416 9.875713e-07 32.93825930
## 2   4        disp -0.135141815 0.033649211 3.035404e-03 -0.21126162
## 3   6 (Intercept) 19.081987419 3.495964315 2.807248e-03 10.09532505
## 4   6        disp  0.003605119 0.020548982 8.676173e-01 -0.04921772
## 5   8 (Intercept) 22.032798914 2.991733959 8.680881e-06 15.51437058
## 6   8        disp -0.019634095 0.009510531 6.128588e-02 -0.04035576
##       ci.upper df outcome
## 1 48.805651347  9     mpg
## 2 -0.059022011  9     mpg
## 3 28.068649785  5     mpg
## 4  0.056427958  5     mpg
## 5 28.551227247 12     mpg
## 6  0.001087572 12     mpg</code></pre>
</div>
<div id="coefficient-plots-with-ggplot2" class="section level2">
<h2 class="hasAnchor">
<a href="#coefficient-plots-with-ggplot2" class="anchor"></a>Coefficient plots with ggplot2</h2>
<p>Having multiple models in a data.frame makes it convenient to make coefficient plots. Here we plot the regression estimate of the slope of <code>mpg</code> with respect to <code>disp</code> for each level of <code>cyl</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">gg_df <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/dplyr/topics/filter">filter</a></span>(term <span class="op">==</span><span class="st"> "disp"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x =</span> estimate, <span class="dt">y =</span> cyl)) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_point">geom_point</a></span>() <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_errorbarh">geom_errorbarh</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">xmin =</span> ci.lower, <span class="dt">xmax =</span> ci.upper), <span class="dt">height =</span> <span class="dv">0</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_abline">geom_vline</a></span>(<span class="dt">xintercept =</span> <span class="dv">0</span>, <span class="dt">linetype =</span> <span class="st">"dashed"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">theme_bw</a></span>()</code></pre></div>
<p><img src="estimatr-in-the-tidyverse_files/figure-html/unnamed-chunk-5-1.png" width="672"></p>
</div>
<div id="multiple-outcome-variables" class="section level2">
<h2 class="hasAnchor">
<a href="#multiple-outcome-variables" class="anchor"></a>Multiple outcome variables</h2>
<p>We could do a similar exercise with three different dependent variables. <code>lm_robust</code> helpfully returns the name of the outcome variable, which makes plotting these models easy:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">gg_df &lt;-
<span class="st">  </span><span class="kw">c</span>(<span class="st">"mpg"</span>, <span class="st">"hp"</span>, <span class="st">"wt"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/map">map</a></span>( <span class="op">~</span><span class="st"> </span><span class="kw"><a href="../reference/lm_robust.html">lm_robust</a></span>(<span class="kw">formula</span>(<span class="kw">paste0</span>(., <span class="st">" ~ disp"</span>)), <span class="dt">data =</span> mtcars)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/map">map_df</a></span>(tidy)
gg_df</code></pre></div>
<pre><code>##          term     estimate    std.error      p.value     ci.lower
## 1 (Intercept) 29.599854756 1.490269e+00 8.189608e-19 26.556319624
## 2        disp -0.041215120 5.170197e-03 6.743097e-09 -0.051774072
## 3 (Intercept) 45.734532208 1.025433e+01 1.064717e-04 24.792392081
## 4        disp  0.437552650 5.450129e-02 5.823354e-09  0.326246164
## 5 (Intercept)  1.599814597 1.675599e-01 1.329415e-10  1.257611729
## 6        disp  0.007010325 7.385652e-04 1.519591e-10  0.005501974
##       ci.upper df outcome
## 1 32.643389889 30     mpg
## 2 -0.030656168 30     mpg
## 3 66.676672334 30      hp
## 4  0.548859136 30      hp
## 5  1.942017464 30      wt
## 6  0.008518677 30      wt</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">gg_df <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/dplyr/topics/filter">filter</a></span>(term <span class="op">==</span><span class="st"> "disp"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(estimate, outcome)) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_point">geom_point</a></span>() <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_errorbarh">geom_errorbarh</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">xmin =</span> ci.lower, <span class="dt">xmax =</span> ci.upper), <span class="dt">height =</span> <span class="dv">0</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_abline">geom_vline</a></span>(<span class="dt">xintercept =</span> <span class="dv">0</span>, <span class="dt">linetype =</span> <span class="st">"dashed"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">theme_bw</a></span>()</code></pre></div>
<p><img src="estimatr-in-the-tidyverse_files/figure-html/unnamed-chunk-6-1.png" width="672"></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#turning-model-objects-into-data-frames">Turning model objects into data.frames</a></li>
      <li><a href="#putting-robust-standard-errors-in-a-ggplot">Putting robust standard errors in a ggplot</a></li>
      <li><a href="#running-multiple-versions-of-a-model-with-purrr">Running multiple versions of a model with purrr</a></li>
      <li><a href="#coefficient-plots-with-ggplot2">Coefficient plots with ggplot2</a></li>
      <li><a href="#multiple-outcome-variables">Multiple outcome variables</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright" style="flex:3;">
  <p>Developed by Graeme Blair, Jasper Cooper, Alexander Coppock, Macartan Humphreys, Luke Sonnet, Neal Fultz.</p>
  <p>Code is licensed under <a href="https://opensource.org/licenses/mit-license.php">MIT</a> license.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
